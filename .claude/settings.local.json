{
  "permissions": {
    "allow": [
      "Bash(dir:*)",
      "Bash(python:*)",
      "Bash(git add:*)",
      "Bash(git commit -m \"$(cat <<''EOF''\nPerf: Implement unified in-memory cache architecture\n\nReplaces DB-based caching with optimized in-memory cache for real-time data.\n\n## Cache Architecture\n\n**Unified Backend Cache** (`services/portfolio_cache.py`):\n- Portfolio balances (updated every 10s by auto-refresh)\n- TWR metrics (invalidated on new snapshot)\n- P&L metrics (invalidated on new snapshot)\n- Thread-safe with lock for concurrent access\n\n## Changes\n\n### Backend\n- **NEW** `backend/services/portfolio_cache.py` - Unified cache service\n- **Modified** `backend/utils/portfolio_utils.py`:\n  - refresh_portfolio_from_binance() now updates cache instead of DB\n  - Removed update_portfolio_balances() function (no longer needed)\n- **Modified** `backend/api/portfolio.py`:\n  - GET /balances reads from cache instead of DB\n  - Removed PortfolioBalance DB queries\n- **Modified** `backend/api/performance.py`:\n  - Added cache layer for TWR calculations (invalidated on snapshot ID change)\n  - Added cache layer for P&L calculations (invalidated on snapshot ID change)\n  - Added latest_snapshot_id to /stats endpoint for cache invalidation\n- **Modified** `backend/services/auto_refresh.py`:\n  - Updated to use cache (already using refresh_portfolio_from_binance)\n  - Removed DB references\n\n### Database Impact\n- `portfolio_balances` table NO LONGER USED (can be dropped manually)\n- `snapshots` and `cash_flows` remain in DB (historical data)\n- `allocation_settings` remains in DB (configuration data)\n\n## Performance Improvements\n\n**Before:**\n- TWR request: ~2-3s (9 DB queries + calculations) Ã— 9 periods = ~20-30s total\n- Portfolio balances: DB SELECT every request\n- Auto-refresh: DB DELETE + INSERT every 10s\n\n**After:**\n- TWR request (cache hit): <10ms Ã— 9 periods = <100ms total\n- TWR request (cache miss): ~2s (calculates once, then cached)\n- Portfolio balances: Instant (in-memory)\n- Auto-refresh: Pure memory update (no DB writes)\n\n## Cache Invalidation Strategy\n\n**Balances Cache:**\n- Updated every 10s by auto-refresh service\n- Always reflects latest Binance data\n\n**TWR/PnL Cache:**\n- Invalidated when latest_snapshot_id changes\n- Ensures calculations always use current snapshot data\n- No arbitrary TTL - smart invalidation based on data changes\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\nEOF\n)\")"
    ]
  }
}
